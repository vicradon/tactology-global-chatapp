<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Socket IO Test</title>
    <link rel="stylesheet" href="styles.css" />

    <script type="importmap">
      {
        "imports": {
          "socket.io-client": "https://cdn.socket.io/4.7.5/socket.io.esm.min.js"
        }
      }
    </script>
  </head>

  <body>
    <div id="connection-status-box"></div>

    <div>
      <div id="authed-view">
        <p id="auth-status-box"></p>
        <button id="logout-button">Logout</button>
      </div>

      <form id="login-form">
        <p>Login Form</p>
        <div>
          <label for="username">Username</label>
          <input
            type="text"
            placeholder="username"
            name="username"
            id="username"
          />
        </div>
        <div>
          <label for="password">Password</label>
          <input
            type="password"
            name="password"
            id="password"
            placeholder="*****"
          />
        </div>
        <button type="submit">login</button>
      </form>
    </div>

    <div id="chat-room">
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <h3 id="current-room-name">General</h3>

        <div>
          <button id="join-room-btn" class="room-action-btn">Join room</button>
          <button id="leave-room-btn" class="room-action-btn">
            Leave room
          </button>
        </div>
      </div>
      <div style="display: flex">
        <div id="users-space">
          <p>Users</p>
          <div id="users"></div>

          <p>Rooms</p>
          <div id="rooms"></div>
        </div>
        <div id="chat-area"></div>
      </div>

      <form id="chat-form">
        <input
          placeholder="say something!"
          type="text"
          name="new-msg-box"
          id="new-msg-box"
        />
        <button type="submit">send</button>
      </form>
    </div>
    <script type="module">
      // Replace the existing JavaScript code in your HTML file with this updated version

      import { io } from "socket.io-client";

      const apiBaseURL = "http://localhost:3500";
      const $ = (query) => document.querySelector(query);

      const chatForm = $("#chat-form");
      const loginForm = $("#login-form");
      const statusIndicatorBox = $("#connection-status-box");
      const authStatusBox = $("#auth-status-box");
      const logoutButton = $("#logout-button");
      const chatArea = $("#chat-area");
      const currentRoomName = $("#current-room-name");
      const joinRoomBtn = $("#join-room-btn");
      const leaveRoomBtn = $("#leave-room-btn");

      let isAuth = false;
      let appReady = false;
      let allUsers = [];
      let allRooms = [];
      let userDetails = { username: "", userId: null };
      let currentRoomId = null;
      let userRooms = []; // Track rooms the user has joined

      const socket = io("http://localhost:3500/", {
        reconnectionDelayMax: 10000,
        withCredentials: true,
      });

      socket.on("connect", () => {
        statusIndicatorBox.innerText = "connected!";
        console.log("connected");
      });

      socket.on("onlineUsersUpdate", (onlineUsers) => {
        setTimeout(() => {
          console.log({ onlineUsers });
          // Only show online users
          const onlineUsersUsernames = onlineUsers.map((user) => user.username);
          const users = allUsers.map((user) => ({
            ...user,
            isOnline: onlineUsersUsernames.includes(user.username),
          }));
          renderUsers(users);
        }, 1000);
      });

      socket.on("error", (error) => {
        console.error("Socket error:", error.message);
        // Display error message to user
        const errorElement = document.createElement("div");
        errorElement.className = "error-message";
        errorElement.textContent = error.message;
        chatArea.appendChild(errorElement);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          errorElement.remove();
        }, 5000);
      });

      setInterval(() => {
        socket.emit("heartbeat");
      }, 30 * 1000);

      socket.on("connect_error", (err) => {
        statusIndicatorBox.innerText = "disconnected";
        console.error("Connection failed:", err.message);
      });

      function renderChatBubble(data) {
        const isCurrentUser = data.username === userDetails.username;

        return `
    <div class="chat-bubble ${isCurrentUser ? "current-user" : ""}">
      <p class="chat-bubble-username">~${data.username}</p>
      <div class="chat-bubble-chatdata">
        <p class="chat-bubble-message">${data.message}</p>
        <p class="chat-bubble-timestamp">${convertToLocalTime(
          data.timestamp
        )}</p>
      </div>
    </div>
  `;
      }

      socket.on("roomPreviousMessages", (messages) => {
        chatArea.innerHTML = "";
        if (messages.length === 0) {
          // If we got an empty array, it could mean:
          // 1. The room is empty
          // 2. The user doesn't have access to this room
          const isJoined = userRooms.some((room) => room.id === currentRoomId);

          if (!isJoined) {
            chatArea.innerHTML = `<div class="info-message">You need to join this room to see messages.</div>`;
          } else {
            chatArea.innerHTML = `<div class="info-message">No messages in this room yet.</div>`;
          }
        } else {
          messages.forEach((msg) => {
            chatArea.innerHTML += renderChatBubble(msg);
          });
        }
        scrollToBottom();
      });

      socket.on("roomMessageBroadcast", (msg) => {
        // Only show messages for the current room
        if (msg.roomId === currentRoomId) {
          chatArea.innerHTML += renderChatBubble(msg);
          scrollToBottom();
        }
      });

      socket.on("userJoinedRoom", (data) => {
        console.log(`${data.username} joined room ${data.roomId}`);
        // Add system message for user joining
        if (data.roomId === currentRoomId) {
          const joinMessage = `
      <div class="system-message">
        <p>${data.username} joined the room</p>
      </div>
    `;
          chatArea.innerHTML += joinMessage;
          scrollToBottom();
        }
      });

      socket.on("disconnect", () => {
        statusIndicatorBox.innerText = "disconnected";
        console.log("Disconnected from server.");
      });

      socket.on("userLeftRoom", (data) => {
        console.log(`${data.username} left room ${data.roomId}`);
        // Add system message for user leaving
        if (data.roomId === currentRoomId) {
          const leaveMessage = `
      <div class="system-message">
        <p>${data.username} left the room</p>
      </div>
    `;
          chatArea.innerHTML += leaveMessage;
          scrollToBottom();
        }
      });

      /**
       * Fetch wrapper function
       * @param {string} endpoint - The endpoint to fetch data from.
       * @param {"GET" | "POST" | "PUT" | "DELETE"} [method="GET"] - HTTP method.
       * @param {Object} [body=null] - Request body for POST/PUT requests.
       * @param {Object} [headers={}] - Additional headers.
       * @returns {Promise<[any, Error|null]>} - Returns a tuple [data, error].
       */
      const useFetch = async (
        endpoint,
        method = "GET",
        body = null,
        headers = {},
        baseURL = "http://localhost:3500"
      ) => {
        try {
          const options = {
            method,
            headers: { "Content-Type": "application/json", ...headers },
            body: body ? JSON.stringify(body) : null,
            credentials: "include",
          };

          const response = await fetch(`${baseURL}${endpoint}`, options);
          if (!response.ok)
            throw new Error(`${response.status} - ${response.statusText}`);
          return [await response.json(), null];
        } catch (error) {
          return [null, error];
        }
      };

      async function renderUsers(users) {
        $("#users").innerHTML = "";
        users.forEach((user) => {
          let baseClass = "user-status-indicator ";
          if (user.isOnline) {
            baseClass += "user-is-online";
          } else {
            baseClass += "user-is-offline";
          }

          $("#users").innerHTML += `
      <div class="user">
        <span class="${baseClass}"></span><p>${user.username}</p>
      </div>
    `;
        });
      }

      function renderRooms(rooms) {
        $("#rooms").innerHTML = "";
        rooms.forEach((room) => {
          const isJoined = userRooms.some((r) => r.id === room.id);
          const isActive = currentRoomId === room.id;

          $("#rooms").innerHTML += `
      <div class="room ${isActive ? "active-room" : ""} ${
            isJoined ? "joined-room" : ""
          }" 
         data-room-id="${room.id}" 
         data-room-name="${room.name}">
      <p>${room.name}</p>
    </div>
    `;
        });

        // Add click event listeners to room elements
        document.querySelectorAll(".room").forEach((roomElement) => {
          roomElement.addEventListener("click", () => {
            const roomId = roomElement.getAttribute("data-room-id");
            const roomName = roomElement.getAttribute("data-room-name");
            selectRoom(roomId, roomName);
          });
        });
      }

      function selectRoom(roomId, roomName) {
        currentRoomId = roomId;
        currentRoomName.textContent = roomName;

        // Update URL with the selected room
        const url = new URL(window.location);
        url.searchParams.set("roomId", roomId);
        window.history.pushState({}, "", url);

        // Update room join/leave buttons
        updateRoomActionButtons();

        // Check if user has joined this room
        const isJoined = userRooms.some((room) => room.id === roomId);

        if (isJoined) {
          // If joined, get messages for this room
          socket.emit("getRoomMessages", { roomId });
        } else {
          // If not joined, show empty message area with join prompt
          chatArea.innerHTML = `<div class="info-message">You need to join this room to see messages.</div>`;
        }
      }

      function updateRoomActionButtons() {
        // Don't show join/leave buttons for the general room
        const isGeneralRoom =
          currentRoomName.textContent.toLowerCase() === "general";

        if (isGeneralRoom) {
          joinRoomBtn.style.display = "none";
          leaveRoomBtn.style.display = "none";
          return;
        }

        // Check if user has already joined this room
        const isJoined = userRooms.some((room) => room.id === currentRoomId);

        joinRoomBtn.style.display = isJoined ? "none" : "inline-block";
        leaveRoomBtn.style.display = isJoined ? "inline-block" : "none";
      }

      async function joinRoom() {
        if (!currentRoomId) return;

        joinRoomBtn.disabled = true;
        joinRoomBtn.textContent = "Joining...";

        try {
          // Emit join room event and wait for response
          socket.emit("joinRoom", { roomId: currentRoomId }, (response) => {
            if (response && response.error) {
              // Show error message
              const errorElement = document.createElement("div");
              errorElement.className = "error-message";
              errorElement.textContent = response.error;
              chatArea.appendChild(errorElement);
              setTimeout(() => errorElement.remove(), 5000);
              return;
            }

            // Add room to user's joined rooms
            const room = allRooms.find((r) => r.id === currentRoomId);
            if (room && !userRooms.some((r) => r.id === room.id)) {
              userRooms.push(room);
            }

            // Update UI
            updateRoomActionButtons();
            renderRooms(allRooms);

            // Request messages for the joined room
            socket.emit("getRoomMessages", { roomId: currentRoomId });
          });
        } catch (error) {
          console.error("Error joining room:", error);
          const errorElement = document.createElement("div");
          errorElement.className = "error-message";
          errorElement.textContent = "Failed to join room";
          chatArea.appendChild(errorElement);
          setTimeout(() => errorElement.remove(), 5000);
        } finally {
          joinRoomBtn.disabled = false;
          joinRoomBtn.textContent = "Join room";
        }
      }

      async function leaveRoom() {
        if (!currentRoomId) return;

        // Don't allow leaving the general room
        if (currentRoomName.textContent.toLowerCase() === "general") {
          return;
        }

        leaveRoomBtn.disabled = true;
        leaveRoomBtn.textContent = "Leaving...";

        try {
          // Emit leave room event and wait for response
          socket.emit("leaveRoom", { roomId: currentRoomId }, (response) => {
            if (response && response.error) {
              // Show error message
              const errorElement = document.createElement("div");
              errorElement.className = "error-message";
              errorElement.textContent = response.error;
              chatArea.appendChild(errorElement);
              setTimeout(() => errorElement.remove(), 5000);
              return;
            }

            // Remove room from user's joined rooms
            userRooms = userRooms.filter((room) => room.id !== currentRoomId);

            // Update UI
            updateRoomActionButtons();
            renderRooms(allRooms);

            // Clear chat area and show join prompt
            chatArea.innerHTML = `<div class="info-message">You need to join this room to see messages.</div>`;
          });
        } catch (error) {
          console.error("Error leaving room:", error);
          const errorElement = document.createElement("div");
          errorElement.className = "error-message";
          errorElement.textContent = "Failed to leave room";
          chatArea.appendChild(errorElement);
          setTimeout(() => errorElement.remove(), 5000);
        } finally {
          leaveRoomBtn.disabled = false;
          leaveRoomBtn.textContent = "Leave room";
        }
      }

      async function initialDataFetch() {
        const usersFetchReq = useFetch("/users");
        const roomsFetchReq = useFetch("/rooms");
        const userRoomsFetchReq = useFetch("/users/rooms"); // Endpoint to get user's rooms

        const [userFetch, roomFetch, userRoomsFetch] = await Promise.all([
          usersFetchReq,
          roomsFetchReq,
          userRoomsFetchReq,
        ]);

        const [users, usersError] = userFetch;
        if (usersError) console.error(usersError);

        allUsers = users.filter((user) => user.username !== "system");
        renderUsers(allUsers);

        const [rooms, roomsFetchError] = roomFetch;
        if (roomsFetchError) console.error(roomsFetchError);

        allRooms = rooms;

        const [userRoomsData, userRoomsError] = userRoomsFetch;
        if (!userRoomsError && userRoomsData) {
          userRooms = userRoomsData;
        } else {
          // Fallback: assume user is at least in general room
          const generalRoom = rooms.find(
            (room) => room.name.toLowerCase() === "general"
          );
          if (generalRoom) {
            userRooms = [generalRoom];
          }
        }

        renderRooms(rooms);

        // Get roomId from URL or use general room as default
        const urlParams = new URLSearchParams(window.location.search);
        const roomIdFromUrl = urlParams.get("roomId");

        if (roomIdFromUrl) {
          const room = rooms.find((r) => r.id === roomIdFromUrl);
          if (room) {
            selectRoom(room.id, room.name);
          } else {
            // Fallback to general room if roomId is invalid
            const generalRoom = rooms.find(
              (room) => room.name.toLowerCase() === "general"
            );
            if (generalRoom) {
              selectRoom(generalRoom.id, generalRoom.name);
            }
          }
        } else {
          // Default to general room if no roomId in URL
          const generalRoom = rooms.find(
            (room) => room.name.toLowerCase() === "general"
          );
          if (generalRoom) {
            selectRoom(generalRoom.id, generalRoom.name);
          }
        }
      }

      loginForm.addEventListener("submit", handleLoginEvent);
      logoutButton.addEventListener("click", handleLogoutEvent);
      chatForm.addEventListener("submit", postChatMessage);
      joinRoomBtn.addEventListener("click", joinRoom);
      leaveRoomBtn.addEventListener("click", leaveRoom);

      async function handleLoginEvent(event) {
        event.preventDefault();
        const username = loginForm["username"].value;
        const password = loginForm["password"].value;
        const [_, error] = await useFetch("/auth/login", "POST", {
          username,
          password,
        });
        if (error) return console.error(error);

        window.location.reload();
      }

      async function handleLogoutEvent(event) {
        const [_, error] = await useFetch("/auth/logout", "POST");

        if (error) {
          console.error(error);
          return;
        }

        isAuth = false;
        authStatusBox.innerText = "Not signed in";
        loginForm.style.display = "block";
        logoutButton.style.display = "none";
        window.location.reload();
      }

      async function fetchUserProfile() {
        const [data, error] = await useFetch("/auth/profile");

        if (error) {
          console.log(`An error occured: ${error}`);
          authStatusBox.innerText = "Not signed in";
          logoutButton.style.display = "none";
          return;
        }

        isAuth = true;
        userDetails.username = data.username;
        userDetails.userId = data.userId || data.sub; // Store the user ID
        loginForm.style.display = "none";
        authStatusBox.innerText = `Signed in as ${data.username}`;
        logoutButton.style.display = "block";
      }

      async function postChatMessage(event) {
        event.preventDefault();
        const msg = chatForm["new-msg-box"].value;

        if (!isAuth) {
          console.error("Cannot post chat message, not authenticated");
          return;
        }

        if (!msg.trim()) {
          return; // Don't send empty messages
        }

        // Check if the user has joined the current room
        const isJoined = userRooms.some((room) => room.id === currentRoomId);
        if (!isJoined) {
          // Display error and don't send message
          const errorElement = document.createElement("div");
          errorElement.className = "error-message";
          errorElement.textContent =
            "You need to join this room to send messages";
          chatArea.appendChild(errorElement);

          // Auto-remove after 5 seconds
          setTimeout(() => {
            errorElement.remove();
          }, 5000);
          return;
        }

        socket.emit("roomMessageEmit", {
          username: userDetails.username,
          message: msg,
          roomId: currentRoomId,
        });

        chatForm["new-msg-box"].value = "";
      }

      function scrollToBottom() {
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      function convertToLocalTime(utcTimestamp) {
        try {
          const utcDate = new Date(utcTimestamp);

          if (isNaN(utcDate)) {
            throw new Error("Invalid UTC timestamp");
          }

          const localTime = utcDate.toLocaleTimeString("en-US", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          });

          return localTime;
        } catch (error) {
          console.error("Error converting time:", error.message);
          return null;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        await fetchUserProfile();
        await initialDataFetch();
        socket.emit("getOnlineUsers");

        appReady = true;
      });
    </script>
  </body>
</html>
